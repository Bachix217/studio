
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- FONCTIONS DE SÉCURITÉ ---

    // Vérifie si la requête vient de VOTRE application (App Check)
    function isValidApp() {
      return request.appCheck != null;
    }

    // Vérifie si l'utilisateur est l'admin via son email
    function isAdmin() {
      return request.auth != null && request.auth.token.email == "info@tacoto.ch";
    }

    // Vérifie si l'utilisateur est le propriétaire du document
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // --- RÈGLES DE COLLECTIONS ---

    // Règles pour les véhicules
    match /vehicles/{vehicleId} {
      allow read: if true; // Les annonces sont publiques

      // On exige App Check pour toute écriture afin d'éviter le spam
      allow create: if isValidApp() && request.auth != null && 
                    (isAdmin() || request.auth.uid == request.resource.data.userId);

      allow update, delete: if isValidApp() && request.auth != null && 
                            (isAdmin() || request.auth.uid == resource.data.userId);
    }
    
    // Annonces archivées
    match /deleted-vehicles/{vehicleId} {
        allow create: if isValidApp() && request.auth != null && 
                      (isAdmin() || request.auth.uid == request.resource.data.userId);
        allow read: if isAdmin();
        allow update, delete: if false;
    }

    // Profils utilisateurs
    match /users/{userId} {
      allow get: if true;
      allow list: if isAdmin();
      
      // Protection des données sensibles du profil
      allow write: if isValidApp() && request.auth != null && (isAdmin() || isOwner(userId));
      
      // Favoris
      match /favorites/{vehicleId} {
        // Le propriétaire du profil peut lire, créer, modifier et supprimer ses propres favoris.
        // App Check est requis pour toute modification.
        allow read: if isOwner(userId);
        allow write: if isValidApp() && isOwner(userId);
      }
    }
    
    // Groupe de collections "images"
    match /{path=**}/images/{imageId} {
      allow get, list: if isAdmin();
    }

    // Accès global Admin (à laisser en dernier)
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
